'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

// imports
var PIXI = require('pixi.js');

// Aliases
var Container = PIXI.Container;

/**
 * @class
 */

var Puppet = function () {

    /**
     * @param {Stage} stage - the stage this puppet will be attached to
     * @param {Object} puppet - object with all the data to construct the puppet
     * @param {number} id - UUID to refer to this puppet later
     */
    function Puppet(stage, puppet, id) {
        _classCallCheck(this, Puppet);

        // Init Variables
        this.babbling = false;
        this.puppet = puppet;
        this.stage = stage;
        this.id = id;
        this.container = new Container();
        this.position = this.target = puppet.position;
        this.facingLeft = puppet.facingLeft;
        this.deadbonesStyle = puppet.deadbonesStyle;
        this.movingAnim = this.eyesAnim = this.mouthAnim = this.deadbonesAnim = 0;
        this.eyesDuration = this.mouthDuration = this.deadbonesDuration = 0;
        this.deadbonesTargetY = this.deadbonesStartY = 0;
        this.deadbonesTargetRotation = this.deadbonesStartRotation = 0;
        this.eyeBabbleDuration = puppet.eyeBabbleDuration || 2000;
        this.mouthBabbleDuration = puppet.mouthBabbleDuration || 270;
        this.direction = 0;
        this.head = [];
        this.emotes = { 0: { base: [], eyes: [], mouth: [] }

            // Construct Puppet
        };this.container.addChild(this.handleLayer(puppet.layers));

        // Finish Setup
        this.changeEmote(puppet.emote);

        // Place Puppet on Stage
        this.container.interactive = true;
        this.container.puppet = this;
        this.container.id = id;
        this.container.y = stage.screen.clientHeight / stage.puppetStage.scale.y;
        this.container.x = (this.position - 0.5) * stage.slotWidth;
        this.container.scale.x = this.container.scale.y = stage.project.puppetScale || 1;
        this.container.scale.x *= this.facingLeft ? -1 : 1;
    }

    _createClass(Puppet, [{
        key: 'handleLayer',
        value: function handleLayer(layer) {
            var _this = this;

            var inherit = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

            var container = new Container();
            Object.keys(layer).forEach(function (k) {
                if (!(k in container)) container[k] = layer[k];
            });
            Object.keys(inherit).forEach(function (k) {
                return inherit[k] == null && delete inherit[k];
            });
            Object.keys(inherit).forEach(function (k) {
                if (!(k in container)) container[k] = inherit[k];
            });

            if (layer.children) {
                var inh = Object.assign(function (_ref) {
                    var head = _ref.head,
                        emote = _ref.emote,
                        emoteLayer = _ref.emoteLayer;
                    return { head: head, emote: emote, emoteLayer: emoteLayer };
                }(layer), inherit);
                layer.children.forEach(function (child) {
                    return container.addChild(_this.handleLayer(child, inh));
                });
            } else {
                container.addChild(this.stage.getAsset(container, layer));
            }

            if (inherit.head == null && layer.head) this.head.push(container);

            if (container.emote != null && (inherit.emoteLayer == null && layer.emoteLayer || !layer.children)) {
                if (!(container.emote in this.emotes)) this.emotes[container.emote] = {
                    base: [],
                    eyes: [],
                    mouth: []
                };
                this.emotes[container.emote][container.emoteLayer ? container.emoteLayer : 'base'].push(container);
            } else if (inherit.babble == null && layer.babble) {
                container.visible = false;
            }

            return container;
        }
    }, {
        key: 'changeEmote',
        value: function changeEmote(emote) {
            this.emote = emote || '0';
            var setEmoteVisible = function setEmoteVisible(visible) {
                return function (emote) {
                    emote.base.forEach(function (layer) {
                        return layer.visible = visible;
                    });
                    emote.eyes.forEach(function (layer) {
                        return layer.visible = visible;
                    });
                    emote.mouth.forEach(function (layer) {
                        return layer.visible = visible;
                    });
                };
            };
            Object.values(this.emotes).forEach(setEmoteVisible(false));
            setEmoteVisible(true)(emote in this.emotes ? this.emotes[emote] : this.emotes['0']);
        }
    }, {
        key: 'setBabbling',
        value: function setBabbling(babble) {
            // Babbling will be triggered by holding down a button,
            //  which could end up calling this function a bunch
            //  so only do anything if we're actually changing the value
            if (this.babbling == babble) return;
            this.babbling = babble;

            if (!babble) {
                this.changeEmote(this.emote);

                if (this.deadbonesStyle) {
                    this.deadbonesAnim = 0;
                    this.deadbonesDuration = 0;
                    this.deadbonesTargetY = this.deadbonesStartY = 0;
                    this.deadbonesTargetRotation = this.deadbonesStartRotation = 0;
                }
            }
        }
    }, {
        key: 'jiggle',
        value: function jiggle() {
            if (this.movingAnim === 0) this.movingAnim = 0.6;
        }
    }, {
        key: 'applyToAsset',
        value: function applyToAsset(id, callback, parent, layer) {
            var _this2 = this;

            layer = layer || this.puppet.layers;

            if (layer.children) {
                layer.children.forEach(function (l) {
                    return _this2.applyToAsset(id, callback, layer, l);
                });
            } else if (layer.id === id) callback(parent, layer);
        }
    }, {
        key: 'update',
        value: function update() {
            var _this3 = this;

            var updateBabble = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;

            // Update position
            this.updatePosition();

            // Update emote
            this.changeEmote(this.emote);

            // Update babble
            if (updateBabble) {
                if (this.deadbonesStyle) {
                    this.deadbonesAnim = 0;
                    this.deadbonesDuration = 100 + Math.random() * 200;
                    this.deadbonesStartY = this.head.y = 10 - Math.random() * 20;
                    this.deadbonesStartRotation = this.head.rotation = 0.1 - Math.random() * 0.2;
                    this.head.forEach(function (a) {
                        a.y = a.asset.y + _this3.deadbonesStartY;
                        a.rotation = a.asset.rotation + _this3.deadbonesStartRotation;
                    });
                    this.deadbonesTargetY = 10 - Math.random() * 20;
                    this.deadbonesTargetRotation = 0.1 - Math.random() * 0.2;
                } else {
                    this.updateEyeBabble();
                    this.updateMouthBabble();
                }
            }
        }
    }, {
        key: 'updatePosition',
        value: function updatePosition() {
            this.container.scale.x = this.container.scale.y = this.stage.project.puppetScale || 1;
            this.container.scale.x *= this.facingLeft ? -1 : 1;
            this.container.y = this.stage.bounds.height / this.stage.puppetStage.scale.y;
            var pos = this.stage.position % (this.stage.project.numCharacters + 1);
            if (pos < 0) pos += this.stage.project.numCharacters + 1;
            this.container.x = this.position <= 0 ? -Math.abs(this.container.width) / 2 : // Starting left of screen
            this.position >= this.stage.project.numCharacters + 1 ? this.stage.project.numCharacters * this.stage.slotWidth + Math.abs(this.container.width) / 2 : // Starting right of screen
            (this.position - 0.5) * this.stage.slotWidth; // Starting on screen
        }
    }, {
        key: 'updateEyeBabble',
        value: function updateEyeBabble() {
            // Disable this emote's eyes
            if (this.emotes[this.emote]) this.emotes[this.emote].eyes.forEach(function (c) {
                return c.visible = false;
            });
            this.emotes['0'].eyes.forEach(function (c) {
                return c.visible = false;
            });

            // Find eyes to set
            var reducer = function reducer(acc, curr) {
                if (curr.babble && curr.emoteLayer === 'eyes') {
                    return acc.concat(curr);
                } else if (curr.children) {
                    return curr.children.reduce(reducer, acc);
                } else return acc;
            };
            var eyes = this.container.children.reduce(reducer, []);
            eyes.forEach(function (e) {
                return e.visible = false;
            });

            // Set new eyes
            ([eyes[Math.floor(Math.random() * eyes.length)]] || this.emotes['0'].eyes).forEach(function (c) {
                return c.visible = true;
            });
            this.eyesAnim = 0;
            this.eyesDuration = (0.1 + Math.random()) * this.eyeBabbleDuration;
        }
    }, {
        key: 'updateMouthBabble',
        value: function updateMouthBabble() {
            // Disable this emote's eyes
            if (this.emotes[this.emote]) this.emotes[this.emote].mouth.forEach(function (c) {
                return c.visible = false;
            });
            this.emotes['0'].mouth.forEach(function (c) {
                return c.visible = false;
            });

            // Find eyes to set
            var reducer = function reducer(acc, curr) {
                if (curr.babble && curr.emoteLayer === 'mouth') {
                    return acc.concat(curr);
                } else if (curr.children) {
                    return curr.children.reduce(reducer, acc);
                } else return acc;
            };
            var mouths = this.container.children.reduce(reducer, []);
            mouths.forEach(function (e) {
                return e.visible = false;
            });

            // Set new mouth
            ([mouths[Math.floor(Math.random() * mouths.length)]] || this.emotes['0'].mouths).forEach(function (c) {
                return c.visible = true;
            });
            this.mouthAnim = 0;
            this.mouthDuration = (0.1 + Math.random()) * this.mouthBabbleDuration;
        }
    }]);

    return Puppet;
}();

module.exports = Puppet;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL3B1cHBldC5qcyJdLCJuYW1lcyI6WyJQSVhJIiwicmVxdWlyZSIsIkNvbnRhaW5lciIsIlB1cHBldCIsInN0YWdlIiwicHVwcGV0IiwiaWQiLCJiYWJibGluZyIsImNvbnRhaW5lciIsInBvc2l0aW9uIiwidGFyZ2V0IiwiZmFjaW5nTGVmdCIsImRlYWRib25lc1N0eWxlIiwibW92aW5nQW5pbSIsImV5ZXNBbmltIiwibW91dGhBbmltIiwiZGVhZGJvbmVzQW5pbSIsImV5ZXNEdXJhdGlvbiIsIm1vdXRoRHVyYXRpb24iLCJkZWFkYm9uZXNEdXJhdGlvbiIsImRlYWRib25lc1RhcmdldFkiLCJkZWFkYm9uZXNTdGFydFkiLCJkZWFkYm9uZXNUYXJnZXRSb3RhdGlvbiIsImRlYWRib25lc1N0YXJ0Um90YXRpb24iLCJleWVCYWJibGVEdXJhdGlvbiIsIm1vdXRoQmFiYmxlRHVyYXRpb24iLCJkaXJlY3Rpb24iLCJoZWFkIiwiZW1vdGVzIiwiYmFzZSIsImV5ZXMiLCJtb3V0aCIsImFkZENoaWxkIiwiaGFuZGxlTGF5ZXIiLCJsYXllcnMiLCJjaGFuZ2VFbW90ZSIsImVtb3RlIiwiaW50ZXJhY3RpdmUiLCJ5Iiwic2NyZWVuIiwiY2xpZW50SGVpZ2h0IiwicHVwcGV0U3RhZ2UiLCJzY2FsZSIsIngiLCJzbG90V2lkdGgiLCJwcm9qZWN0IiwicHVwcGV0U2NhbGUiLCJsYXllciIsImluaGVyaXQiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImsiLCJjaGlsZHJlbiIsImluaCIsImFzc2lnbiIsImVtb3RlTGF5ZXIiLCJjaGlsZCIsImdldEFzc2V0IiwicHVzaCIsImJhYmJsZSIsInZpc2libGUiLCJzZXRFbW90ZVZpc2libGUiLCJ2YWx1ZXMiLCJjYWxsYmFjayIsInBhcmVudCIsImFwcGx5VG9Bc3NldCIsImwiLCJ1cGRhdGVCYWJibGUiLCJ1cGRhdGVQb3NpdGlvbiIsIk1hdGgiLCJyYW5kb20iLCJyb3RhdGlvbiIsImEiLCJhc3NldCIsInVwZGF0ZUV5ZUJhYmJsZSIsInVwZGF0ZU1vdXRoQmFiYmxlIiwiYm91bmRzIiwiaGVpZ2h0IiwicG9zIiwibnVtQ2hhcmFjdGVycyIsImFicyIsIndpZHRoIiwiYyIsInJlZHVjZXIiLCJhY2MiLCJjdXJyIiwiY29uY2F0IiwicmVkdWNlIiwiZSIsImZsb29yIiwibGVuZ3RoIiwibW91dGhzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFDQSxJQUFNQSxPQUFPQyxRQUFRLFNBQVIsQ0FBYjs7QUFFQTtBQUNBLElBQUlDLFlBQVlGLEtBQUtFLFNBQXJCOztBQUVBOzs7O0lBR01DLE07O0FBRUY7Ozs7O0FBS0Esb0JBQVlDLEtBQVosRUFBbUJDLE1BQW5CLEVBQTJCQyxFQUEzQixFQUErQjtBQUFBOztBQUMzQjtBQUNBLGFBQUtDLFFBQUwsR0FBZ0IsS0FBaEI7QUFDQSxhQUFLRixNQUFMLEdBQWNBLE1BQWQ7QUFDQSxhQUFLRCxLQUFMLEdBQWFBLEtBQWI7QUFDQSxhQUFLRSxFQUFMLEdBQVVBLEVBQVY7QUFDQSxhQUFLRSxTQUFMLEdBQWlCLElBQUlOLFNBQUosRUFBakI7QUFDQSxhQUFLTyxRQUFMLEdBQWdCLEtBQUtDLE1BQUwsR0FBY0wsT0FBT0ksUUFBckM7QUFDQSxhQUFLRSxVQUFMLEdBQWtCTixPQUFPTSxVQUF6QjtBQUNBLGFBQUtDLGNBQUwsR0FBc0JQLE9BQU9PLGNBQTdCO0FBQ0EsYUFBS0MsVUFBTCxHQUFrQixLQUFLQyxRQUFMLEdBQWdCLEtBQUtDLFNBQUwsR0FBaUIsS0FBS0MsYUFBTCxHQUFxQixDQUF4RTtBQUNBLGFBQUtDLFlBQUwsR0FBb0IsS0FBS0MsYUFBTCxHQUFxQixLQUFLQyxpQkFBTCxHQUF5QixDQUFsRTtBQUNBLGFBQUtDLGdCQUFMLEdBQXdCLEtBQUtDLGVBQUwsR0FBdUIsQ0FBL0M7QUFDQSxhQUFLQyx1QkFBTCxHQUErQixLQUFLQyxzQkFBTCxHQUE4QixDQUE3RDtBQUNBLGFBQUtDLGlCQUFMLEdBQXlCbkIs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QTlCLENBQVA7QUFDSCxpQkFGTSxNQUVBLE9BQU9BLEdBQVA7QUFDVixhQU5EO0FBT0EsZ0JBQU1PLFNBQVMsS0FBS3BGLFNBQUwsQ0FBZTZDLFFBQWYsQ0FBd0JtQyxNQUF4QixDQUErQkosT0FBL0IsRUFBd0MsRUFBeEMsQ0FBZjtBQUNBUSxtQkFBT3pDLE9BQVAsQ0FBZTtBQUFBLHVCQUFLc0MsRUFBRTVCLE9BQUYsR0FBWSxLQUFqQjtBQUFBLGFBQWY7O0FBRUE7QUFDQSxhQUFDLENBQUMrQixPQUFPdEIsS0FBS29CLEtBQUwsQ0FBV3BCLEtBQUtDLE1BQUwsS0FBZ0JxQixPQUFPRCxNQUFsQyxDQUFQLENBQUQsS0FBdUQsS0FBSy9ELE1BQUwsQ0FBWSxHQUFaLEVBQWlCZ0UsTUFBekUsRUFDSXpDLE9BREosQ0FDWTtBQUFBLHVCQUFLZ0MsRUFBRXRCLE9BQUYsR0FBWSxJQUFqQjtBQUFBLGFBRFo7QUFFQSxpQkFBSzlDLFNBQUwsR0FBaUIsQ0FBakI7QUFDQSxpQkFBS0csYUFBTCxHQUFxQixDQUFDLE1BQU1vRCxLQUFLQyxNQUFMLEVBQVAsSUFBd0IsS0FBSzlDLG1CQUFsRDtBQUNIOzs7Ozs7QUFHTG9FLE9BQU9DLE9BQVAsR0FBaUIzRixNQUFqQiIsImZpbGUiOiJwdXBwZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnRzXG5jb25zdCBQSVhJID0gcmVxdWlyZSgncGl4aS5qcycpXG5cbi8vIEFsaWFzZXNcbmxldCBDb250YWluZXIgPSBQSVhJLkNvbnRhaW5lclxuXG4vKipcbiAqIEBjbGFzc1xuICovXG5jbGFzcyBQdXBwZXQge1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtTdGFnZX0gc3RhZ2UgLSB0aGUgc3RhZ2UgdGhpcyBwdXBwZXQgd2lsbCBiZSBhdHRhY2hlZCB0b1xuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwdXBwZXQgLSBvYmplY3Qgd2l0aCBhbGwgdGhlIGRhdGEgdG8gY29uc3RydWN0IHRoZSBwdXBwZXRcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gaWQgLSBVVUlEIHRvIHJlZmVyIHRvIHRoaXMgcHVwcGV0IGxhdGVyXG4gICAgICovXG4gICAgY29uc3RydWN0b3Ioc3RhZ2UsIHB1cHBldCwgaWQpIHtcbiAgICAgICAgLy8gSW5pdCBWYXJpYWJsZXNcbiAgICAgICAgdGhpcy5iYWJibGluZyA9IGZhbHNlXG4gICAgICAgIHRoaXMucHVwcGV0ID0gcHVwcGV0XG4gICAgICAgIHRoaXMuc3RhZ2UgPSBzdGFnZVxuICAgICAgICB0aGlzLmlkID0gaWRcbiAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgQ29udGFpbmVyKClcbiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMudGFyZ2V0ID0gcHVwcGV0LnBvc2l0aW9uXG4gICAgICAgIHRoaXMuZmFjaW5nTGVmdCA9IHB1cHBldC5mYWNpbmdMZWZ0XG4gICAgICAgIHRoaXMuZGVhZGJvbmVzU3R5bGUgPSBwdXBwZXQuZGVhZGJvbmVzU3R5bGVcbiAgICAgICAgdGhpcy5tb3ZpbmdBbmltID0gdGhpcy5leWVzQW5pbSA9IHRoaXMubW91dGhBbmltID0gdGhpcy5kZWFkYm9uZXNBbmltID0gMFxuICAgICAgICB0aGlzLmV5ZXNEdXJhdGlvbiA9IHRoaXMubW91dGhEdXJhdGlvbiA9IHRoaXMuZGVhZGJvbmVzRHVyYXRpb24gPSAwXG4gICAgICAgIHRoaXMuZGVhZGJvbmVzVGFyZ2V0WSA9IHRoaXMuZGVhZGJvbmVzU3RhcnRZID0gMFxuICAgICAgICB0aGlzLmRlYWRib25lc1RhcmdldFJvdGF0aW9uID0gdGhpcy5kZWFkYm9uZXNTdGFydFJvdGF0aW9uID0gMFxuICAgICAgICB0aGlzLmV5ZUJhYmJsZUR1cmF0aW9uID0gcHVwcGV0LmV5ZUJhYmJsZUR1cmF0aW9uIHx8IDIwMDBcbiAgICAgICAgdGhpcy5tb3V0aEJhYmJsZUR1cmF0aW9uID0gcHVwcGV0Lm1vdXRoQmFiYmxlRHVyYXRpb24gfHwgMjcwXG4gICAgICAgIHRoaXMuZGlyZWN0aW9uID0gMFxuICAgICAgICB0aGlzLmhlYWQgPSBbXVxuICAgICAgICB0aGlzLmVtb3RlcyA9IHsgMDogeyBiYXNlOiBbXSwgZXllczogW10sIG1vdXRoOiBbXSB9IH1cblxuICAgICAgICAvLyBDb25zdHJ1Y3QgUHVwcGV0XG4gICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENoaWxkKHRoaXMuaGFuZGxlTGF5ZXIocHVwcGV0LmxheWVycykpXG5cbiAgICAgICAgLy8gRmluaXNoIFNldHVwXG4gICAgICAgIHRoaXMuY2hhbmdlRW1vdGUocHVwcGV0LmVtb3RlKVxuXG4gICAgICAgIC8vIFBsYWNlIFB1cHBldCBvbiBTdGFnZVxuICAgICAgICB0aGlzLmNvbnRhaW5lci5pbnRlcmFjdGl2ZSA9IHRydWVcbiAgICAgICAgdGhpcy5jb250YWluZXIucHVwcGV0ID0gdGhpc1xuICAgICAgICB0aGlzLmNvbnRhaW5lci5pZCA9IGlkXG4gICAgICAgIHRoaXMuY29udGFpbmVyLnkgPSBzdGFnZS5zY3JlZW4uY2xpZW50SGVpZ2h0IC8gc3RhZ2UucHVwcGV0U3RhZ2Uuc2NhbGUueVxuICAgICAgICB0aGlzLmNvbnRhaW5lci54ID0gKHRoaXMucG9zaXRpb24gLSAwLjUpICogc3RhZ2Uuc2xvdFdpZHRoXG4gICAgICAgIHRoaXMuY29udGFpbmVyLnNjYWxlLnggPSB0aGlzLmNvbnRhaW5lci5zY2FsZS55ID1cbiAgICAgICAgICAgIChzdGFnZS5wcm9qZWN0LnB1cHBldFNjYWxlIHx8IDEpIFxuICAgICAgICB0aGlzLmNvbnRhaW5lci5zY2FsZS54ICo9IHRoaXMuZmFjaW5nTGVmdCA/IC0xIDogMVxuICAgIH1cblxuICAgIGhhbmRsZUxheWVyKGxheWVyLCBpbmhlcml0ID0ge30pIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpXG4gICAgICAgIE9iamVjdC5rZXlzKGxheWVyKS5mb3JFYWNoKGsgPT4ge2lmICghKGsgaW4gY29udGFpbmVyKSkgY29udGFpbmVyW2tdID0gbGF5ZXJba119KVxuICAgICAgICBPYmplY3Qua2V5cyhpbmhlcml0KS5mb3JFYWNoKGsgPT4gaW5oZXJpdFtrXSA9PSBudWxsICYmIGRlbGV0ZSBpbmhlcml0W2tdKVxuICAgICAgICBPYmplY3Qua2V5cyhpbmhlcml0KS5mb3JFYWNoKGsgPT4ge2lmICghKGsgaW4gY29udGFpbmVyKSkgY29udGFpbmVyW2tdID0gaW5oZXJpdFtrXX0pXG5cbiAgICAgICAgaWYgKGxheWVyLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBjb25zdCBpbmggPSBPYmplY3QuYXNzaWduKCgoeyBoZWFkLCBlbW90ZSwgZW1vdGVMYXllciB9KSA9PlxuICAgICAgICAgICAgICAgICh7IGhlYWQsIGVtb3RlLCBlbW90ZUxheWVyIH0pKShsYXllciksIGluaGVyaXQpXG4gICAgICAgICAgICBsYXllci5jaGlsZHJlbi5mb3JFYWNoKGNoaWxkID0+XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLmFkZENoaWxkKHRoaXMuaGFuZGxlTGF5ZXIoY2hpbGQsIGluaCkpKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udGFpbmVyLmFkZENoaWxkKHRoaXMuc3RhZ2UuZ2V0QXNzZXQoY29udGFpbmVyLCBsYXllcikpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaW5oZXJpdC5oZWFkID09IG51bGwgJiYgbGF5ZXIuaGVhZClcbiAgICAgICAgICAgIHRoaXMuaGVhZC5wdXNoKGNvbnRhaW5lcilcblxuICAgICAgICBpZiAoY29udGFpbmVyLmVtb3RlICE9IG51bGwgJiYgKGluaGVyaXQuZW1vdGVMYXllciA9PSBudWxsICYmIGxheWVyLmVtb3RlTGF5ZXIgfHwgIWxheWVyLmNoaWxkcmVuKSkge1xuICAgICAgICAgICAgaWYgKCEoY29udGFpbmVyLmVtb3RlIGluIHRoaXMuZW1vdGVzKSkgdGhpcy5lbW90ZXNbY29udGFpbmVyLmVtb3RlXSA9IHtcbiAgICAgICAgICAgICAgICBiYXNlOiBbXSxcbiAgICAgICAgICAgICAgICBleWVzOiBbXSxcbiAgICAgICAgICAgICAgICBtb3V0aDogW11cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZW1vdGVzW2NvbnRhaW5lci5lbW90ZV1bY29udGFpbmVyLmVtb3RlTGF5ZXIgP1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5lbW90ZUxheWVyIDogJ2Jhc2UnXS5wdXNoKGNvbnRhaW5lcilcbiAgICAgICAgfSBlbHNlIGlmIChpbmhlcml0LmJhYmJsZSA9PSBudWxsICYmIGxheWVyLmJhYmJsZSkge1xuICAgICAgICAgICAgY29udGFpbmVyLnZpc2libGUgPSBmYWxzZVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbnRhaW5lclxuICAgIH1cblxuICAgIGNoYW5nZUVtb3RlKGVtb3RlKSB7XG4gICAgICAgIHRoaXMuZW1vdGUgPSBlbW90ZSB8fCAnMCdcbiAgICAgICAgY29uc3Qgc2V0RW1vdGVWaXNpYmxlID0gdmlzaWJsZSA9PiBlbW90ZSA9PiB7XG4gICAgICAgICAgICBlbW90ZS5iYXNlLmZvckVhY2gobGF5ZXIgPT4gbGF5ZXIudmlzaWJsZSA9IHZpc2libGUpXG4gICAgICAgICAgICBlbW90ZS5leWVzLmZvckVhY2gobGF5ZXIgPT4gbGF5ZXIudmlzaWJsZSA9IHZpc2libGUpXG4gICAgICAgICAgICBlbW90ZS5tb3V0aC5mb3JFYWNoKGxheWVyID0+IGxheWVyLnZpc2libGUgPSB2aXNpYmxlKVxuICAgICAgICB9XG4gICAgICAgIE9iamVjdC52YWx1ZXModGhpcy5lbW90ZXMpLmZvckVhY2goc2V0RW1vdGVWaXNpYmxlKGZhbHNlKSlcbiAgICAgICAgc2V0RW1vdGVWaXNpYmxlKHRydWUpKGVtb3RlIGluIHRoaXMuZW1vdGVzID9cbiAgICAgICAgICAgIHRoaXMuZW1vdGVzW2Vtb3RlXSA6XG4gICAgICAgICAgICB0aGlzLmVtb3Rlc1snMCddKVxuICAgIH1cblxuICAgIHNldEJhYmJsaW5nKGJhYmJsZSkge1xuICAgICAgICAvLyBCYWJibGluZyB3aWxsIGJlIHRyaWdnZXJlZCBieSBob2xkaW5nIGRvd24gYSBidXR0b24sXG4gICAgICAgIC8vICB3aGljaCBjb3VsZCBlbmQgdXAgY2FsbGluZyB0aGlzIGZ1bmN0aW9uIGEgYnVuY2hcbiAgICAgICAgLy8gIHNvIG9ubHkgZG8gYW55dGhpbmcgaWYgd2UncmUgYWN0dWFsbHkgY2hhbmdpbmcgdGhlIHZhbHVlXG4gICAgICAgIGlmICh0aGlzLmJhYmJsaW5nID09IGJhYmJsZSkgcmV0dXJuXG4gICAgICAgIHRoaXMuYmFiYmxpbmcgPSBiYWJibGVcblxuICAgICAgICBpZiAoIWJhYmJsZSkge1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2VFbW90ZSh0aGlzLmVtb3RlKVxuXG4gICAgICAgICAgICBpZiAodGhpcy5kZWFkYm9uZXNTdHlsZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVhZGJvbmVzQW5pbSA9IDBcbiAgICAgICAgICAgICAgICB0aGlzLmRlYWRib25lc0R1cmF0aW9uID0gMFxuICAgICAgICAgICAgICAgIHRoaXMuZGVhZGJvbmVzVGFyZ2V0WSA9IHRoaXMuZGVhZGJvbmVzU3RhcnRZID0gMFxuICAgICAgICAgICAgICAgIHRoaXMuZGVhZGJvbmVzVGFyZ2V0Um90YXRpb24gPSB0aGlzLmRlYWRib25lc1N0YXJ0Um90YXRpb24gPSAwXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBqaWdnbGUoKSB7XG4gICAgICAgIGlmICh0aGlzLm1vdmluZ0FuaW0gPT09IDApIHRoaXMubW92aW5nQW5pbSA9IDAuNlxuICAgIH1cblxuICAgIGFwcGx5VG9Bc3NldChpZCwgY2FsbGJhY2ssIHBhcmVudCwgbGF5ZXIpIHtcbiAgICAgICAgbGF5ZXIgPSBsYXllciB8fCB0aGlzLnB1cHBldC5sYXllcnNcbiAgICAgICAgXG4gICAgICAgIGlmIChsYXllci5jaGlsZHJlbikge1xuICAgICAgICAgICAgbGF5ZXIuY2hpbGRyZW4uZm9yRWFjaChsID0+IHRoaXMuYXBwbHlUb0Fzc2V0KGlkLCBjYWxsYmFjaywgbGF5ZXIsIGwpKVxuICAgICAgICB9IGVsc2UgaWYgKGxheWVyLmlkID09PSBpZClcbiAgICAgICAgICAgIGNhbGxiYWNrKHBhcmVudCwgbGF5ZXIpXG4gICAgfVxuXG4gICAgdXBkYXRlKHVwZGF0ZUJhYmJsZSA9IHRydWUpIHtcbiAgICAgICAgLy8gVXBkYXRlIHBvc2l0aW9uXG4gICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oKVxuXG4gICAgICAgIC8vIFVwZGF0ZSBlbW90ZVxuICAgICAgICBjaGFuZ2VFbW90ZSh0aGlzLmVtb3RlKVxuXG4gICAgICAgIC8vIFVwZGF0ZSBiYWJibGVcbiAgICAgICAgaWYgKHVwZGF0ZUJhYmJsZSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZGVhZGJvbmVzU3R5bGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYWRib25lc0FuaW0gPSAwXG4gICAgICAgICAgICAgICAgdGhpcy5kZWFkYm9uZXNEdXJhdGlvbiA9IDEwMCArIE1hdGgucmFuZG9tKCkgKiAyMDBcbiAgICAgICAgICAgICAgICB0aGlzLmRlYWRib25lc1N0YXJ0WSA9IHRoaXMuaGVhZC55ID0gMTAgLSBNYXRoLnJhbmRvbSgpICogMjBcbiAgICAgICAgICAgICAgICB0aGlzLmRlYWRib25lc1N0YXJ0Um90YXRpb24gPSB0aGlzLmhlYWQucm90YXRpb24gPSAwLjEgLSBNYXRoLnJhbmRvbSgpICogMC4yXG4gICAgICAgICAgICAgICAgdGhpcy5oZWFkLmZvckVhY2goYSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGEueSA9IGEuYXNzZXQueSArIHRoaXMuZGVhZGJvbmVzU3RhcnRZXG4gICAgICAgICAgICAgICAgICAgIGEucm90YXRpb24gPSBhLmFzc2V0LnJvdGF0aW9uICsgdGhpcy5kZWFkYm9uZXNTdGFydFJvdGF0aW9uXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB0aGlzLmRlYWRib25lc1RhcmdldFkgPSAxMCAtIE1hdGgucmFuZG9tKCkgKiAyMFxuICAgICAgICAgICAgICAgIHRoaXMuZGVhZGJvbmVzVGFyZ2V0Um90YXRpb24gPSAwLjEgLSBNYXRoLnJhbmRvbSgpICogMC4yXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRXllQmFiYmxlKClcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU1vdXRoQmFiYmxlKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVwZGF0ZVBvc2l0aW9uKCkge1xuICAgICAgICB0aGlzLmNvbnRhaW5lci5zY2FsZS54ID0gdGhpcy5jb250YWluZXIuc2NhbGUueSA9ICh0aGlzLnN0YWdlLnByb2plY3QucHVwcGV0U2NhbGUgfHwgMSkgXG4gICAgICAgIHRoaXMuY29udGFpbmVyLnNjYWxlLnggKj0gdGhpcy5mYWNpbmdMZWZ0ID8gLTEgOiAxXG4gICAgICAgIHRoaXMuY29udGFpbmVyLnkgPSB0aGlzLnN0YWdlLmJvdW5kcy5oZWlnaHQgLyB0aGlzLnN0YWdlLnB1cHBldFN0YWdlLnNjYWxlLnlcbiAgICAgICAgbGV0IHBvcyA9IHRoaXMuc3RhZ2UucG9zaXRpb24gJSAodGhpcy5zdGFnZS5wcm9qZWN0Lm51bUNoYXJhY3RlcnMgKyAxKVxuICAgICAgICBpZiAocG9zIDwgMCkgcG9zICs9IHRoaXMuc3RhZ2UucHJvamVjdC5udW1DaGFyYWN0ZXJzICsgMVxuICAgICAgICB0aGlzLmNvbnRhaW5lci54ID0gdGhpcy5wb3NpdGlvbiA8PSAwID8gLSBNYXRoLmFicyh0aGlzLmNvbnRhaW5lci53aWR0aCkgLyAyIDogICAgICAgICAgICAgICAgICAgICAgLy8gU3RhcnRpbmcgbGVmdCBvZiBzY3JlZW5cbiAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA+PSB0aGlzLnN0YWdlLnByb2plY3QubnVtQ2hhcmFjdGVycyArIDEgPyBcbiAgICAgICAgICAgdGhpcy5zdGFnZS5wcm9qZWN0Lm51bUNoYXJhY3RlcnMgKiB0aGlzLnN0YWdlLnNsb3RXaWR0aCArIE1hdGguYWJzKHRoaXMuY29udGFpbmVyLndpZHRoKSAvIDIgOiAgIC8vIFN0YXJ0aW5nIHJpZ2h0IG9mIHNjcmVlblxuICAgICAgICAgICAodGhpcy5wb3NpdGlvbiAtIDAuNSkgKiB0aGlzLnN0YWdlLnNsb3RXaWR0aCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RhcnRpbmcgb24gc2NyZWVuXG4gICAgfVxuXG4gICAgdXBkYXRlRXllQmFiYmxlKCkge1xuICAgICAgICAvLyBEaXNhYmxlIHRoaXMgZW1vdGUncyBleWVzXG4gICAgICAgIGlmICh0aGlzLmVtb3Rlc1t0aGlzLmVtb3RlXSkgdGhpcy5lbW90ZXNbdGhpcy5lbW90ZV0uZXllcy5mb3JFYWNoKGMgPT4gYy52aXNpYmxlID0gZmFsc2UpXG4gICAgICAgIHRoaXMuZW1vdGVzWycwJ10uZXllcy5mb3JFYWNoKGMgPT4gYy52aXNpYmxlID0gZmFsc2UpXG5cbiAgICAgICAgLy8gRmluZCBleWVzIHRvIHNldFxuICAgICAgICBjb25zdCByZWR1Y2VyID0gKGFjYywgY3VycikgPT4ge1xuICAgICAgICAgICAgaWYgKGN1cnIuYmFiYmxlICYmIGN1cnIuZW1vdGVMYXllciA9PT0gJ2V5ZXMnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjYy5jb25jYXQoY3VycilcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY3Vyci5jaGlsZHJlbikge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdXJyLmNoaWxkcmVuLnJlZHVjZShyZWR1Y2VyLCBhY2MpXG4gICAgICAgICAgICB9IGVsc2UgcmV0dXJuIGFjY1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGV5ZXMgPSB0aGlzLmNvbnRhaW5lci5jaGlsZHJlbi5yZWR1Y2UocmVkdWNlciwgW10pXG4gICAgICAgIGV5ZXMuZm9yRWFjaChlID0+IGUudmlzaWJsZSA9IGZhbHNlKTtcblxuICAgICAgICAvLyBTZXQgbmV3IGV5ZXNcbiAgICAgICAgKFtleWVzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGV5ZXMubGVuZ3RoKV1dIHx8IHRoaXMuZW1vdGVzWycwJ10uZXllcykuXG4gICAgICAgICAgICBmb3JFYWNoKGMgPT4gYy52aXNpYmxlID0gdHJ1ZSlcbiAgICAgICAgdGhpcy5leWVzQW5pbSA9IDBcbiAgICAgICAgdGhpcy5leWVzRHVyYXRpb24gPSAoMC4xICsgTWF0aC5yYW5kb20oKSkgKiB0aGlzLmV5ZUJhYmJsZUR1cmF0aW9uXG4gICAgfVxuXG4gICAgdXBkYXRlTW91dGhCYWJibGUoKSB7XG4gICAgICAgIC8vIERpc2FibGUgdGhpcyBlbW90ZSdzIGV5ZXNcbiAgICAgICAgaWYgKHRoaXMuZW1vdGVzW3RoaXMuZW1vdGVdKSB0aGlzLmVtb3Rlc1t0aGlzLmVtb3RlXS5tb3V0aC5mb3JFYWNoKGMgPT4gYy52aXNpYmxlID0gZmFsc2UpXG4gICAgICAgIHRoaXMuZW1vdGVzWycwJ10ubW91dGguZm9yRWFjaChjID0+IGMudmlzaWJsZSA9IGZhbHNlKVxuXG4gICAgICAgIC8vIEZpbmQgZXllcyB0byBzZXRcbiAgICAgICAgY29uc3QgcmVkdWNlciA9IChhY2MsIGN1cnIpID0+IHtcbiAgICAgICAgICAgIGlmIChjdXJyLmJhYmJsZSAmJiBjdXJyLmVtb3RlTGF5ZXIgPT09ICdtb3V0aCcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYWNjLmNvbmNhdChjdXJyKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnIuY2hpbGRyZW4ucmVkdWNlKHJlZHVjZXIsIGFjYylcbiAgICAgICAgICAgIH0gZWxzZSByZXR1cm4gYWNjXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbW91dGhzID0gdGhpcy5jb250YWluZXIuY2hpbGRyZW4ucmVkdWNlKHJlZHVjZXIsIFtdKVxuICAgICAgICBtb3V0aHMuZm9yRWFjaChlID0+IGUudmlzaWJsZSA9IGZhbHNlKTtcblxuICAgICAgICAvLyBTZXQgbmV3IG1vdXRoXG4gICAgICAgIChbbW91dGhzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG1vdXRocy5sZW5ndGgpXV0gfHwgdGhpcy5lbW90ZXNbJzAnXS5tb3V0aHMpLlxuICAgICAgICAgICAgZm9yRWFjaChjID0+IGMudmlzaWJsZSA9IHRydWUpXG4gICAgICAgIHRoaXMubW91dGhBbmltID0gMFxuICAgICAgICB0aGlzLm1vdXRoRHVyYXRpb24gPSAoMC4xICsgTWF0aC5yYW5kb20oKSkgKiB0aGlzLm1vdXRoQmFiYmxlRHVyYXRpb25cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUHVwcGV0XG4iXX0=