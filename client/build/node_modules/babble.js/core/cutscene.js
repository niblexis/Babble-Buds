"use strict";

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/**
 * Cutscene Scripts:
 * Each action is an object with a "command" string for the action to perform, a "wait" boolean for whether or not to
 * wait until the action is complete before continuing, and any other parameters the command might need (sometimes optional)
 * e.g. { "action": "move", "target": "protagonist", "position": 2, "wait": true }
 * 
 * Default commands:
 * run {script} - takes a new script object to be run in parallel with the rest of the cutscene. Only useful with "wait" set to "false"
 * add {name} {id} [position] [facingLeft] [emote] - adds a puppet with the given name at the given position, assigns it the given id for later reference, and optionally overrides initial state
 * set {target} {name} - changes the given puppet (using assigned ids) to a new puppet with the given name
 * remove {target} - removes a given puppet from the stage
 * delay {duration} - simply waits, should generally be used as a ";" action
 * move {target} {position} - moves puppet to a new position
 * facingLeft {target} {facingLeft} - forces puppet direction
 * babble {target} [start/stop/toggle] - makes a puppet start or stop babbling. Default is toggle
 * emote {target} [emote] - makes a puppet switch to a given emote. Default is 'default'
 * jiggle {target} - causes a given puppet to jiggle
 *
 * Actions are defined in the cutscene's "actions" object. You can add functions to that object to add custom actions.
 * The function will be passed a callback function to be called when the action is complete, as well as the action object with all the parameters in it
 * You can use `this` to access references to the stage and actors
 *
 * To start the cutscene, just call cutscene.start()
 *
 * @class
 */
var Cutscene = function () {

    /**
     * @param {Stage} stage - the stage this puppet will be attached to
     * @param {Object[]} script - the script for the cutscene
     * @param {Object} actors - dictionary of actors (e.g. each member is "name": Character)
     * @param {requestCallback} callback - function to be called after cutscene finishes (either successfully or after an error)
     */
    function Cutscene(stage, script, actors, callback) {
        _classCallCheck(this, Cutscene);

        this.stage = stage;
        this.actors = actors;

        this.start = function () {
            this.parseNextAction(script, callback);
        };

        this.actions = {
            run: function run(callback, action) {
                if (action.wait) {
                    this.parseNextAction(action.script, callback);
                } else {
                    this.parseNextAction(action.script, this.empty);
                    requestAnimationFrame(callback);
                }
            },
            add: function add(callback, action) {
                if (this.stage.getPuppet(action.id)) throw new Error("Actor already on stage!");
                if (!(action.name in this.actors)) throw new Error("Could not find puppet with that name!");

                // Copy our actor from our actors object
                var actor = JSON.parse(JSON.stringify(this.actors[action.name]));

                // If optional parameters are set, apply them to our actor
                if (action.hasOwnProperty('position')) actor.position = action.position;
                if (action.hasOwnProperty('facingLeft')) actor.facingLeft = action.facingLeft;
                if (action.hasOwnProperty('emote')) actor.emote = action.emote;

                // Add our actor to the stage
                this.stage.addPuppet(actor, action.id).name = action.name;
                callback();
            },
            set: function set(callback, action) {
                if (!this.stage.getPuppet(action.target)) throw new Error("Actor not present on stage!");
                if (!(action.name in this.actors)) throw new Error("Could not find puppet with that name!");

                this.stage.setPuppet(action.target, this.stage.createPuppet(this.actors[action.name])).name = action.name;
                callback();
            },
            remove: function remove(callback, action) {
                if (!this.stage.getPuppet(action.target)) throw new Error("Actor not present on stage!");

                this.stage.removePuppet(action.target);
                callback();
            },
            delay: function delay(callback, action) {
                if (action.delay <= 0) requestAnimationFrame(callback);else {
                    var timer = PIXI.timerManager.createTimer(action.delay);
                    timer.on('end', callback);
                    timer.start();
                }
            },
            move: function move(callback, action) {
                if (!this.stage.getPuppet(action.target)) throw new Error("Actor not present on stage!");

                var puppet = this.stage.getPuppet(action.target);
                if (puppet.target == puppet.position && puppet.position == action.position) {
                    callback();
                    return;
                }

                puppet.target = action.position;
                puppet.movingAnim = 0;
                if (action.position > puppet.position) {
                    puppet.facingLeft = false;
                    puppet.container.scale.x = this.stage.project.puppetScale;
                } else if (action.position != puppet.position) {
                    puppet.facingLeft = true;
                    puppet.container.scale.x = -this.stage.project.puppetScale;
                }
                this.actions.delay(callback, { delay: (Math.abs(puppet.target - puppet.position) * this.stage.MOVE_DURATION * 0.6 + this.stage.MOVE_DURATION * 0.4) * 1000, parent: action });
            },
            facingLeft: function facingLeft(callback, action) {
                if (!this.stage.getPuppet(action.target)) throw new Error("Actor not present on stage!");

                var puppet = this.stage.getPuppet(action.target);
                puppet.facingLeft = action.facingLeft;
                puppet.container.scale.x = (puppet.facingLeft ? -1 : 1) * this.stage.project.puppetScale;
                callback();
            },
            babble: function babble(callback, action) {
                if (!this.stage.getPuppet(action.target)) throw new Error("Actor not present on stage!");

                var puppet = this.stage.getPuppet(action.target);
                var babble = (action.action || "toggle") === "toggle" ? !puppet.babbling : action.action === "start";
                puppet.setBabbling(babble);
                callback();
            },
            emote: function emote(callback, action) {
                if (!this.stage.getPuppet(action.target)) throw new Error("Actor not present on stage!");

                this.stage.getPuppet(action.target).changeEmote(action.emote || "0");
                callback();
            },
            jiggle: function jiggle(callback, action) {
                if (!this.stage.getPuppet(action.target)) throw new Error("Actor not present on stage!");

                this.stage.getPuppet(action.target).jiggle();
                this.actions.delay(callback, { delay: this.stage.MOVE_DURATION * 0.4 * 1000, parent: action });
            }
        };
    }

    _createClass(Cutscene, [{
        key: "parseNextAction",
        value: function parseNextAction(script, callback) {
            // Check if script is complete
            if (script.length === 0) {
                // Cutscene finished successully
                if (callback) requestAnimationFrame(callback);
                return;
            }

            // Parse current line of script
            var action = script[0];

            // Confirm command exists
            if (!action || !this.actions.hasOwnProperty(action.command)) {
                // Invalid command, end cutscene
                if (callback) requestAnimationFrame(callback);
                return;
            }

            // Run action
            if (action.wait) {
                // Complete this action before proceeding
                var newCallback = function () {
                    this.parseNextAction(script.slice(1), callback);
                }.bind(this);
                this.actions[action.command].call(this, newCallback, action);
            } else {
                // Perform this action and immediately continue
                this.actions[action.command].call(this, this.empty, action);
                this.parseNextAction(script.slice(1), callback);
            }
        }

        // Used for callbacks that don't need to do anything. 
        // Used so actions don't need to deal with undefined or null callbacks, 
        //  and to not mess up the parameter order

    }, {
        key: "empty",
        value: function empty() {}
    }]);

    return Cutscene;
}();

module.exports = Cutscene;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL2N1dHNjZW5lLmpzIl0sIm5hbWVzIjpbIkN1dHNjZW5lIiwic3RhZ2UiLCJzY3JpcHQiLCJhY3RvcnMiLCJjYWxsYmFjayIsInN0YXJ0IiwicGFyc2VOZXh0QWN0aW9uIiwiYWN0aW9ucyIsInJ1biIsImFjdGlvbiIsIndhaXQiLCJlbXB0eSIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImFkZCIsImdldFB1cHBldCIsImlkIiwiRXJyb3IiLCJuYW1lIiwiYWN0b3IiLCJKU09OIiwicGFyc2UiLCJzdHJpbmdpZnkiLCJoYXNPd25Qcm9wZXJ0eSIsInBvc2l0aW9uIiwiZmFjaW5nTGVmdCIsImVtb3RlIiwiYWRkUHVwcGV0Iiwic2V0IiwidGFyZ2V0Iiwic2V0UHVwcGV0IiwiY3JlYXRlUHVwcGV0IiwicmVtb3ZlIiwicmVtb3ZlUHVwcGV0IiwiZGVsYXkiLCJ0aW1lciIsIlBJWEkiLCJ0aW1lck1hbmFnZXIiLCJjcmVhdGVUaW1lciIsIm9uIiwibW92ZSIsInB1cHBldCIsIm1vdmluZ0FuaW0iLCJjb250YWluZXIiLCJzY2FsZSIsIngiLCJwcm9qZWN0IiwicHVwcGV0U2NhbGUiLCJNYXRoIiwiYWJzIiwiTU9WRV9EVVJBVElPTiIsInBhcmVudCIsImJhYmJsZSIsImJhYmJsaW5nIiwic2V0QmFiYmxpbmciLCJjaGFuZ2VFbW90ZSIsImppZ2dsZSIsImxlbmd0aCIsImNvbW1hbmQiLCJuZXdDYWxsYmFjayIsInNsaWNlIiwiYmluZCIsImNhbGwiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUEwQk1BLFE7O0FBRUY7Ozs7OztBQU1BLHNCQUFZQyxLQUFaLEVBQW1CQyxNQUFuQixFQUEyQkMsTUFBM0IsRUFBbUNDLFFBQW5DLEVBQTZDO0FBQUE7O0FBQ3pDLGFBQUtILEtBQUwsR0FBYUEsS0FBYjtBQUNBLGFBQUtFLE1BQUwsR0FBY0EsTUFBZDs7QUFFQSxhQUFLRSxLQUFMLEdBQWEsWUFBVztBQUFDLGlCQUFLQyxlQUFMLENBQXFCSixNQUFyQixFQUE2QkUsUUFBN0I7QUFBdUMsU0FBaEU7O0FBRUEsYUFBS0csT0FBTCxHQUFlO0FBQ1hDLGlCQUFLLGFBQVNKLFFBQVQsRUFBbUJLLE1BQW5CLEVBQTJCO0FBQzVCLG9CQUFJQSxPQUFPQyxJQUFYLEVBQWlCO0FBQ2IseUJBQUtKLGVBQUwsQ0FBcUJHLE9BQU9QLE1BQTVCLEVBQW9DRSxRQUFwQztBQUNILGlCQUZELE1BRU87QUFDSCx5QkFBS0UsZUFBTCxDQUFxQkcsT0FBT1AsTUFBNUIsRUFBb0MsS0FBS1MsS0FBekM7QUFDQUMsMENBQXNCUixRQUF0QjtBQUNIO0FBQ0osYUFSVTtBQVNYUyxpQkFBSyxhQUFTVCxRQUFULEVBQW1CSyxNQUFuQixFQUEyQjtBQUM1QixvQkFBSSxLQUFLUixLQUFMLENBQVdhLFNBQVgsQ0FBcUJMLE9BQU9NLEVBQTVCLENBQUosRUFBcUMsTUFBTSxJQUFJQyxLQUFKLENBQVUseUJBQVYsQ0FBTjtBQUNyQyxvQkFBSSxFQUFFUCxPQUFPUSxJQUFQLElBQWUsS0FBS2QsTUFBdEIsQ0FBSixFQUFtQyxNQUFNLElBQUlhLEtBQUosQ0FBVSx1Q0FBVixDQUFOOztBQUVuQztBQUNBLG9CQUFJRSxRQUFRQyxLQUFLQyxLQUFMLENBQVdELEtBQUtFLFNBQUwsQ0FBZSxLQUFLbEIsTUFBTCxDQUFZTSxPQUFPUSxJQUFuQixDQUFmLENBQVgsQ0FBWjs7QUFFQTtBQUNBLG9CQUFJUixPQUFPYSxjQUFQLENBQXNCLFVBQXRCLENBQUosRUFBdUNKLE1BQU1LLFFBQU4sR0FBaUJkLE9BQU9jLFFBQXhCO0FBQ3ZDLG9CQUFJZCxPQUFPYSxjQUFQLENBQXNCLFlBQXRCLENBQUosRUFBeUNKLE1BQU1NLFVBQU4sR0FBbUJmLE9BQU9lLFVBQTFCO0FBQ3pDLG9CQUFJZixPQUFPYSxjQUFQLENBQXNCLE9BQXRCLENBQUosRUFBb0NKLE1BQU1PLEtBQU4sR0FBY2hCLE9BQU9nQixLQUFyQjs7QUFFcEM7QUFDQSxxQkFBS3hCLEtBQUwsQ0FBV3lCLFNBQVgsQ0FBcUJSLEtBQXJCLEVBQTRCVCxPQUFPTSxFQUFuQyxFQUF1Q0UsSUFBdkMsR0FBOENSLE9BQU9RLElBQXJEO0FBQ0FiO0FBQ0gsYUF4QlU7QUF5Qlh1QixpQkFBSyxhQUFTdkIsUUFBVCxFQUFtQkssTUFBbkIsRUFBMkI7QUFDNUIsb0JBQUksQ0FBQyxLQUFLUixLQUFMLENBQVdhLFNBQVgsQ0FBcUJMLE9BQU9tQixNQUE1QixDQUFMLEVBQTBDLE1BQU0sSUFBSVosS0FBSixDQUFVLDZCQUFWLENBQU47QUFDMUMsb0JBQUksRUFBRVAsT0FBT1EsSUFBUCxJQUFlLEtBQUtkLE1BQXRCLENBQUosRUFBbUMsTUFBTSxJQUFJYSxLQUFKLENBQVUsdUNBQVYsQ0FBTjs7QUFFbkMscUJBQUtmLEtBQUwsQ0FBVzRCLFNBQVgsQ0FBcUJwQixPQUFPbUIsTUFBNUIsRUFBb0MsS0FBSzNCLEtBQUwsQ0FBVzZCLFlBQVgsQ0FBd0IsS0FBSzNCLE1BQUwsQ0FBWU0sT0FBT1EsSUFBbkIsQ0FBeEIsQ0FBcEMsRUFBdUZBLElBQXZGLEdBQThGUixPQUFPUSxJQUFyRztBQUNBYjtBQUNILGFBL0JVO0FBZ0NYMkIsb0JBQVEsZ0JBQVMzQixRQUFULEVBQW1CSyxNQUFuQixFQUEyQjtBQUMvQixvQkFBSSxDQUFDLEtBQUtSLEtBQUwsQ0FBV2EsU0FBWCxDQUFxQkwsT0FBT21CLE1BQTVCLENBQUwsRUFBMEMsTUFBTSxJQUFJWixLQUFKLENBQVUsNkJBQVYsQ0FBTjs7QUFFMUMscUJBQUtmLEtBQUwsQ0FBVytCLFlBQVgsQ0FBd0J2QixPQUFPbUIsTUFBL0I7QUFDQXhCO0FBQ0gsYUFyQ1U7QUFzQ1g2QixtQkFBTyxlQUFTN0IsUUFBVCxFQUFtQkssTUFBbkIsRUFBMkI7QUFDOUIsb0JBQUlBLE9BQU93QixLQUFQLElBQWdCLENBQXBCLEVBQXVCckIsc0JBQXNCUixRQUF0QixFQUF2QixLQUNLO0FBQ0Qsd0JBQUk4QixRQUFRQyxLQUFLQyxZQUFMLENBQWtCQyxXQUFsQixDQUE4QjVCLE9BQU93QixLQUFyQyxDQUFaO0FBQ0FDLDBCQUFNSSxFQUFOLENBQVMsS0FBVCxFQUFnQmxDLFFBQWhCO0FBQ0E4QiwwQkFBTTdCLEtBQU47QUFDSDtBQUNKLGFBN0NVO0FBOENYa0Msa0JBQU0sY0FBU25DLFFBQVQsRUFBbUJLLE1BQW5CLEVBQTJCO0FBQzdCLG9CQUFJLENBQUMsS0FBS1IsS0FBTCxDQUFXYSxTQUFYLENBQXFCTCxPQUFPbUIsTUFBNUIsQ0FBTCxFQUEwQyxNQUFNLElBQUlaLEtBQUosQ0FBVSw2QkFBVixDQUFOOztBQUUxQyxvQkFBSXdCLFNBQVMsS0FBS3ZDLEtBQUwsQ0FBV2EsU0FBWCxDQUFxQkwsT0FBT21CLE1BQTVCLENBQWI7QUFDQSxvQkFBSVksT0FBT1osTUFBUCxJQUFpQlksT0FBT2pCLFFBQXhCLElBQW9DaUIsT0FBT2pCLFFBQVAsSUFBbUJkLE9BQU9jLFFBQWxFLEVBQTRFO0FBQ3hFbkI7QUFDQTtBQUNIOztBQUVEb0MsdUJBQU9aLE1BQVAsR0FBZ0JuQixPQUFPYyxRQUF2QjtBQUNBaUIsdUJBQU9DLFVBQVAsR0FBb0IsQ0FBcEI7QUFDQSxvQkFBSWhDLE9BQU9jLFFBQVAsR0FBa0JpQixPQUFPakIsUUFBN0IsRUFBdUM7QUFDbkNpQiwyQkFBT2hCLFVBQVAsR0FBb0IsS0FBcEI7QUFDQWdCLDJCQUFPRSxTQUFQLENBQWlCQyxLQUFqQixDQUF1QkMsQ0FBdkIsR0FBMkIsS0FBSzNDLEtBQUwsQ0FBVzRDLE9BQVgsQ0FBbUJDLFdBQTlDO0FBQ0gsaUJBSEQsTUFHTyxJQUFJckMsT0FBT2MsUUFBUCxJQUFtQmlCLE9BQU9qQixRQUE5QixFQUF3QztBQUMzQ2lCLDJCQUFPaEIsVUFBUCxHQUFvQixJQUFwQjtBQUNBZ0IsMkJBQU9FLFNBQVAsQ0FBaUJDLEtBQWpCLENBQXVCQyxDQUF2QixHQUEyQixDQUFDLEtBQUszQyxLQUFMLENBQVc0QyxPQUFYLENBQW1CQyxXQUEvQztBQUNIO0FBQ0QscUJBQUt2QyxPQUFMLENBQWEwQixLQUFiLENBQW1CN0IsUUFBbkIsRUFBNkIsRUFBRTZCLE9BQU8sQ0FBQ2MsS0FBS0MsR0FBTCxDQUFTUixPQUFPWixNQUFQLEdBQWdCWSxPQUFPakIsUUFBaEMsSUFBNEMsS0FBS3RCLEtBQUwsQ0FBV2dELGFBQXZELEdBQXVFLEdBQXZFLEdBQTZFLEtBQUtoRCxLQUFMLENBQVdnRCxhQUFYLEdBQTJCLEdBQXpHLElBQWdILElBQXpILEVBQStIQyxRQUFRekMsTUFBdkksRUFBN0I7QUFDSCxhQWpFVTtBQWtFWGUsd0JBQVksb0JBQVNwQixRQUFULEVBQW1CSyxNQUFuQixFQUEyQjtBQUNuQyxvQkFBSSxDQUFDLEtBQUtSLEtBQUwsQ0FBV2EsU0FBWCxDQUFxQkwsT0FBT21CLE1BQTVCLENBQUwsRUFBMEMsTUFBTSxJQUFJWixLQUFKLENBQVUsNkJBQVYsQ0FBTjs7QUFFMUMsb0JBQUl3QixTQUFTLEtBQUt2QyxLQUFMLENBQVdhLFNBQVgsQ0FBcUJMLE9BQU9tQixNQUE1QixDQUFiO0FBQ0FZLHVCQUFPaEIsVUFBUCxHQUFvQmYsT0FBT2UsVUFBM0I7QUFDQWdCLHVCQUFPRSxTQUFQLENBQWlCQyxLQUFqQixDQUF1QkMsQ0FBdkIsR0FBMkIsQ0FBQ0osT0FBT2hCLFVBQVAsR0FBb0IsQ0FBQyxDQUFyQixHQUF5QixDQUExQixJQUErQixLQUFLdkIsS0FBTCxDQUFXNEMsT0FBWCxDQUFtQkMsV0FBN0U7QUFDQTFDO0FBQ0gsYUF6RVU7QUEwRVgrQyxvQkFBUSxnQkFBUy9DLFFBQVQsRUFBbUJLLE1BQW5CLEVBQTJCO0FBQy9CLG9CQUFJLENBQUMsS0FBS1IsS0FBTCxDQUFXYSxTQUFYLENBQXFCTCxPQUFPbUIsTUFBNUIsQ0FBTCxFQUEwQyxNQUFNLElBQUlaLEtBQUosQ0FBVSw2QkFBVixDQUFOOztBQUUxQyxvQkFBSXdCLFNBQVMsS0FBS3ZDLEtBQUwsQ0FBV2EsU0FBWCxDQUFxQkwsT0FBT21CLE1BQTVCLENBQWI7QUFDQSxvQkFBSXVCLFNBQVMsQ0FBQzFDLE9BQU9BLE1BQVAsSUFBaUIsUUFBbEIsTUFBZ0MsUUFBaEMsR0FBMkMsQ0FBQytCLE9BQU9ZLFFBQW5ELEdBQThEM0MsT0FBT0EsTUFBUCxLQUFrQixPQUE3RjtBQUNBK0IsdUJBQU9hLFdBQVAsQ0FBbUJGLE1BQW5CO0FBQ0EvQztBQUNILGFBakZVO0FBa0ZYcUIsbUJBQU8sZUFBU3JCLFFBQVQsRUFBbUJLLE1BQW5CLEVBQTJCO0FBQzlCLG9CQUFJLENBQUMsS0FBS1IsS0FBTCxDQUFXYSxTQUFYLENBQXFCTCxPQUFPbUIsTUFBNUIsQ0FBTCxFQUEwQyxNQUFNLElBQUlaLEtBQUosQ0FBVSw2QkFBVixDQUFOOztBQUUxQyxxQkFBS2YsS0FBTCxDQUFXYSxTQUFYLENBQXFCTCxPQUFPbUIsTUFBNUIsRUFBb0MwQixXQUFwQyxDQUFnRDdDLE9BQU9nQixLQUFQLElBQWdCLEdBQWhFO0FBQ0FyQjtBQUNILGFBdkZVO0FBd0ZYbUQsb0JBQVEsZ0JBQVNuRCxRQUFULEVBQW1CSyxNQUFuQixFQUEyQjtBQUMvQixvQkFBSSxDQUFDLEtBQUtSLEtBQUwsQ0FBV2EsU0FBWCxDQUFxQkwsT0FBT21CLE1BQTVCLENBQUwsRUFBMEMsTUFBTSxJQUFJWixLQUFKLENBQVUsNkJBQVYsQ0FBTjs7QUFFMUMscUJBQUtmLEtBQUwsQ0FBV2EsU0FBWCxDQUFxQkwsT0FBT21CLE1BQTVCLEVBQW9DMkIsTUFBcEM7QUFDQSxxQkFBS2hELE9BQUwsQ0FBYTBCLEtBQWIsQ0FBbUI3QixRQUFuQixFQUE2QixFQUFFNkIsT0FBTyxLQUFLaEMsS0FBTCxDQUFXZ0QsYUFBWCxHQUEyQixHQUEzQixHQUFpQyxJQUExQyxFQUFnREMsUUFBUXpDLE1BQXhELEVBQTdCO0FBQ0g7QUE3RlUsU0FBZjtBQStGSDs7Ozt3Q0FFZVAsTSxFQUFRRSxRLEVBQVU7QUFDOUI7QUFDQSxnQkFBSUYsT0FBT3NELE1BQVAsS0FBa0IsQ0FBdEIsRUFBeUI7QUFDckI7QUFDQSxvQkFBSXBELFFBQUosRUFBY1Esc0JBQXNCUixRQUF0QjtBQUNkO0FBQ0g7O0FBRUQ7QUFDQSxnQkFBSUssU0FBU1AsT0FBTyxDQUFQLENBQWI7O0FBRUE7QUFDQSxnQkFBSSxDQUFDTyxNQUFELElBQVcsQ0FBQyxLQUFLRixPQUFMLENBQWFlLGNBQWIsQ0FBNEJiLE9BQU9nRCxPQUFuQyxDQUFoQixFQUE2RDtBQUN6RDtBQUNBLG9CQUFJckQsUUFBSixFQUFjUSxzQkFBc0JSLFFBQXRCO0FBQ2Q7QUFDSDs7QUFFRDtBQUNBLGdCQUFJSyxPQUFPQyxJQUFYLEVBQWlCO0FBQ2I7QUFDQSxvQkFBSWdELGNBQWMsWUFBVztBQUN6Qix5QkFBS3BELGVBQUwsQ0FBcUJKLE9BQU95RCxLQUFQLENBQWEsQ0FBYixDQUFyQixFQUFzQ3ZELFFBQXRDO0FBQ0gsaUJBRmlCLENBRWhCd0QsSUFGZ0IsQ0FFWCxJQUZXLENBQWxCO0FBR0EscUJBQUtyRCxPQUFMLENBQWFFLE9BQU9nRCxPQUFwQixFQUE2QkksSUFBN0IsQ0FBa0MsSUFBbEMsRUFBd0NILFdBQXhDLEVBQXFEakQsTUFBckQ7QUFDSCxhQU5ELE1BTU87QUFDSDtBQUNBLHFCQUFLRixPQUFMLENBQWFFLE9BQU9nRCxPQUFwQixFQUE2QkksSUFBN0IsQ0FBa0MsSUFBbEMsRUFBd0MsS0FBS2xELEtBQTdDLEVBQW9ERixNQUFwRDtBQUNBLHFCQUFLSCxlQUFMLENBQXFCSixPQUFPeUQsS0FBUCxDQUFhLENBQWIsQ0FBckIsRUFBc0N2RCxRQUF0QztBQUNIO0FBQ0o7O0FBRUQ7QUFDQTtBQUNBOzs7O2dDQUNRLENBQUU7Ozs7OztBQUdkMEQsT0FBT0MsT0FBUCxHQUFpQi9ELFFBQWpCIiwiZmlsZSI6ImN1dHNjZW5lLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDdXRzY2VuZSBTY3JpcHRzOlxuICogRWFjaCBhY3Rpb24gaXMgYW4gb2JqZWN0IHdpdGggYSBcImNvbW1hbmRcIiBzdHJpbmcgZm9yIHRoZSBhY3Rpb24gdG8gcGVyZm9ybSwgYSBcIndhaXRcIiBib29sZWFuIGZvciB3aGV0aGVyIG9yIG5vdCB0b1xuICogd2FpdCB1bnRpbCB0aGUgYWN0aW9uIGlzIGNvbXBsZXRlIGJlZm9yZSBjb250aW51aW5nLCBhbmQgYW55IG90aGVyIHBhcmFtZXRlcnMgdGhlIGNvbW1hbmQgbWlnaHQgbmVlZCAoc29tZXRpbWVzIG9wdGlvbmFsKVxuICogZS5nLiB7IFwiYWN0aW9uXCI6IFwibW92ZVwiLCBcInRhcmdldFwiOiBcInByb3RhZ29uaXN0XCIsIFwicG9zaXRpb25cIjogMiwgXCJ3YWl0XCI6IHRydWUgfVxuICogXG4gKiBEZWZhdWx0IGNvbW1hbmRzOlxuICogcnVuIHtzY3JpcHR9IC0gdGFrZXMgYSBuZXcgc2NyaXB0IG9iamVjdCB0byBiZSBydW4gaW4gcGFyYWxsZWwgd2l0aCB0aGUgcmVzdCBvZiB0aGUgY3V0c2NlbmUuIE9ubHkgdXNlZnVsIHdpdGggXCJ3YWl0XCIgc2V0IHRvIFwiZmFsc2VcIlxuICogYWRkIHtuYW1lfSB7aWR9IFtwb3NpdGlvbl0gW2ZhY2luZ0xlZnRdIFtlbW90ZV0gLSBhZGRzIGEgcHVwcGV0IHdpdGggdGhlIGdpdmVuIG5hbWUgYXQgdGhlIGdpdmVuIHBvc2l0aW9uLCBhc3NpZ25zIGl0IHRoZSBnaXZlbiBpZCBmb3IgbGF0ZXIgcmVmZXJlbmNlLCBhbmQgb3B0aW9uYWxseSBvdmVycmlkZXMgaW5pdGlhbCBzdGF0ZVxuICogc2V0IHt0YXJnZXR9IHtuYW1lfSAtIGNoYW5nZXMgdGhlIGdpdmVuIHB1cHBldCAodXNpbmcgYXNzaWduZWQgaWRzKSB0byBhIG5ldyBwdXBwZXQgd2l0aCB0aGUgZ2l2ZW4gbmFtZVxuICogcmVtb3ZlIHt0YXJnZXR9IC0gcmVtb3ZlcyBhIGdpdmVuIHB1cHBldCBmcm9tIHRoZSBzdGFnZVxuICogZGVsYXkge2R1cmF0aW9ufSAtIHNpbXBseSB3YWl0cywgc2hvdWxkIGdlbmVyYWxseSBiZSB1c2VkIGFzIGEgXCI7XCIgYWN0aW9uXG4gKiBtb3ZlIHt0YXJnZXR9IHtwb3NpdGlvbn0gLSBtb3ZlcyBwdXBwZXQgdG8gYSBuZXcgcG9zaXRpb25cbiAqIGZhY2luZ0xlZnQge3RhcmdldH0ge2ZhY2luZ0xlZnR9IC0gZm9yY2VzIHB1cHBldCBkaXJlY3Rpb25cbiAqIGJhYmJsZSB7dGFyZ2V0fSBbc3RhcnQvc3RvcC90b2dnbGVdIC0gbWFrZXMgYSBwdXBwZXQgc3RhcnQgb3Igc3RvcCBiYWJibGluZy4gRGVmYXVsdCBpcyB0b2dnbGVcbiAqIGVtb3RlIHt0YXJnZXR9IFtlbW90ZV0gLSBtYWtlcyBhIHB1cHBldCBzd2l0Y2ggdG8gYSBnaXZlbiBlbW90ZS4gRGVmYXVsdCBpcyAnZGVmYXVsdCdcbiAqIGppZ2dsZSB7dGFyZ2V0fSAtIGNhdXNlcyBhIGdpdmVuIHB1cHBldCB0byBqaWdnbGVcbiAqXG4gKiBBY3Rpb25zIGFyZSBkZWZpbmVkIGluIHRoZSBjdXRzY2VuZSdzIFwiYWN0aW9uc1wiIG9iamVjdC4gWW91IGNhbiBhZGQgZnVuY3Rpb25zIHRvIHRoYXQgb2JqZWN0IHRvIGFkZCBjdXN0b20gYWN0aW9ucy5cbiAqIFRoZSBmdW5jdGlvbiB3aWxsIGJlIHBhc3NlZCBhIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBhY3Rpb24gaXMgY29tcGxldGUsIGFzIHdlbGwgYXMgdGhlIGFjdGlvbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHBhcmFtZXRlcnMgaW4gaXRcbiAqIFlvdSBjYW4gdXNlIGB0aGlzYCB0byBhY2Nlc3MgcmVmZXJlbmNlcyB0byB0aGUgc3RhZ2UgYW5kIGFjdG9yc1xuICpcbiAqIFRvIHN0YXJ0IHRoZSBjdXRzY2VuZSwganVzdCBjYWxsIGN1dHNjZW5lLnN0YXJ0KClcbiAqXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgQ3V0c2NlbmUge1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtTdGFnZX0gc3RhZ2UgLSB0aGUgc3RhZ2UgdGhpcyBwdXBwZXQgd2lsbCBiZSBhdHRhY2hlZCB0b1xuICAgICAqIEBwYXJhbSB7T2JqZWN0W119IHNjcmlwdCAtIHRoZSBzY3JpcHQgZm9yIHRoZSBjdXRzY2VuZVxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBhY3RvcnMgLSBkaWN0aW9uYXJ5IG9mIGFjdG9ycyAoZS5nLiBlYWNoIG1lbWJlciBpcyBcIm5hbWVcIjogQ2hhcmFjdGVyKVxuICAgICAqIEBwYXJhbSB7cmVxdWVzdENhbGxiYWNrfSBjYWxsYmFjayAtIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBhZnRlciBjdXRzY2VuZSBmaW5pc2hlcyAoZWl0aGVyIHN1Y2Nlc3NmdWxseSBvciBhZnRlciBhbiBlcnJvcilcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihzdGFnZSwgc2NyaXB0LCBhY3RvcnMsIGNhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMuc3RhZ2UgPSBzdGFnZVxuICAgICAgICB0aGlzLmFjdG9ycyA9IGFjdG9yc1xuXG4gICAgICAgIHRoaXMuc3RhcnQgPSBmdW5jdGlvbigpIHt0aGlzLnBhcnNlTmV4dEFjdGlvbihzY3JpcHQsIGNhbGxiYWNrKX1cblxuICAgICAgICB0aGlzLmFjdGlvbnMgPSB7XG4gICAgICAgICAgICBydW46IGZ1bmN0aW9uKGNhbGxiYWNrLCBhY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLndhaXQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJzZU5leHRBY3Rpb24oYWN0aW9uLnNjcmlwdCwgY2FsbGJhY2spXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJzZU5leHRBY3Rpb24oYWN0aW9uLnNjcmlwdCwgdGhpcy5lbXB0eSlcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGNhbGxiYWNrKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhZGQ6IGZ1bmN0aW9uKGNhbGxiYWNrLCBhY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFnZS5nZXRQdXBwZXQoYWN0aW9uLmlkKSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0b3IgYWxyZWFkeSBvbiBzdGFnZSFcIilcbiAgICAgICAgICAgICAgICBpZiAoIShhY3Rpb24ubmFtZSBpbiB0aGlzLmFjdG9ycykpIHRocm93IG5ldyBFcnJvcihcIkNvdWxkIG5vdCBmaW5kIHB1cHBldCB3aXRoIHRoYXQgbmFtZSFcIilcblxuICAgICAgICAgICAgICAgIC8vIENvcHkgb3VyIGFjdG9yIGZyb20gb3VyIGFjdG9ycyBvYmplY3RcbiAgICAgICAgICAgICAgICBsZXQgYWN0b3IgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuYWN0b3JzW2FjdGlvbi5uYW1lXSkpXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gSWYgb3B0aW9uYWwgcGFyYW1ldGVycyBhcmUgc2V0LCBhcHBseSB0aGVtIHRvIG91ciBhY3RvclxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb24uaGFzT3duUHJvcGVydHkoJ3Bvc2l0aW9uJykpIGFjdG9yLnBvc2l0aW9uID0gYWN0aW9uLnBvc2l0aW9uXG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbi5oYXNPd25Qcm9wZXJ0eSgnZmFjaW5nTGVmdCcpKSBhY3Rvci5mYWNpbmdMZWZ0ID0gYWN0aW9uLmZhY2luZ0xlZnRcbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLmhhc093blByb3BlcnR5KCdlbW90ZScpKSBhY3Rvci5lbW90ZSA9IGFjdGlvbi5lbW90ZVxuXG4gICAgICAgICAgICAgICAgLy8gQWRkIG91ciBhY3RvciB0byB0aGUgc3RhZ2VcbiAgICAgICAgICAgICAgICB0aGlzLnN0YWdlLmFkZFB1cHBldChhY3RvciwgYWN0aW9uLmlkKS5uYW1lID0gYWN0aW9uLm5hbWVcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihjYWxsYmFjaywgYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YWdlLmdldFB1cHBldChhY3Rpb24udGFyZ2V0KSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0b3Igbm90IHByZXNlbnQgb24gc3RhZ2UhXCIpXG4gICAgICAgICAgICAgICAgaWYgKCEoYWN0aW9uLm5hbWUgaW4gdGhpcy5hY3RvcnMpKSB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZmluZCBwdXBwZXQgd2l0aCB0aGF0IG5hbWUhXCIpXG5cbiAgICAgICAgICAgICAgICB0aGlzLnN0YWdlLnNldFB1cHBldChhY3Rpb24udGFyZ2V0LCB0aGlzLnN0YWdlLmNyZWF0ZVB1cHBldCh0aGlzLmFjdG9yc1thY3Rpb24ubmFtZV0pKS5uYW1lID0gYWN0aW9uLm5hbWVcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihjYWxsYmFjaywgYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YWdlLmdldFB1cHBldChhY3Rpb24udGFyZ2V0KSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0b3Igbm90IHByZXNlbnQgb24gc3RhZ2UhXCIpXG5cbiAgICAgICAgICAgICAgICB0aGlzLnN0YWdlLnJlbW92ZVB1cHBldChhY3Rpb24udGFyZ2V0KVxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkZWxheTogZnVuY3Rpb24oY2FsbGJhY2ssIGFjdGlvbikge1xuICAgICAgICAgICAgICAgIGlmIChhY3Rpb24uZGVsYXkgPD0gMCkgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGNhbGxiYWNrKVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsZXQgdGltZXIgPSBQSVhJLnRpbWVyTWFuYWdlci5jcmVhdGVUaW1lcihhY3Rpb24uZGVsYXkpXG4gICAgICAgICAgICAgICAgICAgIHRpbWVyLm9uKCdlbmQnLCBjYWxsYmFjaylcbiAgICAgICAgICAgICAgICAgICAgdGltZXIuc3RhcnQoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtb3ZlOiBmdW5jdGlvbihjYWxsYmFjaywgYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YWdlLmdldFB1cHBldChhY3Rpb24udGFyZ2V0KSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0b3Igbm90IHByZXNlbnQgb24gc3RhZ2UhXCIpXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHB1cHBldCA9IHRoaXMuc3RhZ2UuZ2V0UHVwcGV0KGFjdGlvbi50YXJnZXQpXG4gICAgICAgICAgICAgICAgaWYgKHB1cHBldC50YXJnZXQgPT0gcHVwcGV0LnBvc2l0aW9uICYmIHB1cHBldC5wb3NpdGlvbiA9PSBhY3Rpb24ucG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcHVwcGV0LnRhcmdldCA9IGFjdGlvbi5wb3NpdGlvblxuICAgICAgICAgICAgICAgIHB1cHBldC5tb3ZpbmdBbmltID0gMFxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb24ucG9zaXRpb24gPiBwdXBwZXQucG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcHVwcGV0LmZhY2luZ0xlZnQgPSBmYWxzZVxuICAgICAgICAgICAgICAgICAgICBwdXBwZXQuY29udGFpbmVyLnNjYWxlLnggPSB0aGlzLnN0YWdlLnByb2plY3QucHVwcGV0U2NhbGVcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbi5wb3NpdGlvbiAhPSBwdXBwZXQucG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcHVwcGV0LmZhY2luZ0xlZnQgPSB0cnVlXG4gICAgICAgICAgICAgICAgICAgIHB1cHBldC5jb250YWluZXIuc2NhbGUueCA9IC10aGlzLnN0YWdlLnByb2plY3QucHVwcGV0U2NhbGVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zLmRlbGF5KGNhbGxiYWNrLCB7IGRlbGF5OiAoTWF0aC5hYnMocHVwcGV0LnRhcmdldCAtIHB1cHBldC5wb3NpdGlvbikgKiB0aGlzLnN0YWdlLk1PVkVfRFVSQVRJT04gKiAwLjYgKyB0aGlzLnN0YWdlLk1PVkVfRFVSQVRJT04gKiAwLjQpICogMTAwMCwgcGFyZW50OiBhY3Rpb24gfSlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmYWNpbmdMZWZ0OiBmdW5jdGlvbihjYWxsYmFjaywgYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YWdlLmdldFB1cHBldChhY3Rpb24udGFyZ2V0KSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0b3Igbm90IHByZXNlbnQgb24gc3RhZ2UhXCIpXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHB1cHBldCA9IHRoaXMuc3RhZ2UuZ2V0UHVwcGV0KGFjdGlvbi50YXJnZXQpXG4gICAgICAgICAgICAgICAgcHVwcGV0LmZhY2luZ0xlZnQgPSBhY3Rpb24uZmFjaW5nTGVmdFxuICAgICAgICAgICAgICAgIHB1cHBldC5jb250YWluZXIuc2NhbGUueCA9IChwdXBwZXQuZmFjaW5nTGVmdCA/IC0xIDogMSkgKiB0aGlzLnN0YWdlLnByb2plY3QucHVwcGV0U2NhbGVcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYmFiYmxlOiBmdW5jdGlvbihjYWxsYmFjaywgYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YWdlLmdldFB1cHBldChhY3Rpb24udGFyZ2V0KSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0b3Igbm90IHByZXNlbnQgb24gc3RhZ2UhXCIpXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHB1cHBldCA9IHRoaXMuc3RhZ2UuZ2V0UHVwcGV0KGFjdGlvbi50YXJnZXQpXG4gICAgICAgICAgICAgICAgbGV0IGJhYmJsZSA9IChhY3Rpb24uYWN0aW9uIHx8IFwidG9nZ2xlXCIpID09PSBcInRvZ2dsZVwiID8gIXB1cHBldC5iYWJibGluZyA6IGFjdGlvbi5hY3Rpb24gPT09IFwic3RhcnRcIlxuICAgICAgICAgICAgICAgIHB1cHBldC5zZXRCYWJibGluZyhiYWJibGUpXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVtb3RlOiBmdW5jdGlvbihjYWxsYmFjaywgYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YWdlLmdldFB1cHBldChhY3Rpb24udGFyZ2V0KSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0b3Igbm90IHByZXNlbnQgb24gc3RhZ2UhXCIpXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhpcy5zdGFnZS5nZXRQdXBwZXQoYWN0aW9uLnRhcmdldCkuY2hhbmdlRW1vdGUoYWN0aW9uLmVtb3RlIHx8IFwiMFwiKVxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBqaWdnbGU6IGZ1bmN0aW9uKGNhbGxiYWNrLCBhY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc3RhZ2UuZ2V0UHVwcGV0KGFjdGlvbi50YXJnZXQpKSB0aHJvdyBuZXcgRXJyb3IoXCJBY3RvciBub3QgcHJlc2VudCBvbiBzdGFnZSFcIilcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0aGlzLnN0YWdlLmdldFB1cHBldChhY3Rpb24udGFyZ2V0KS5qaWdnbGUoKVxuICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9ucy5kZWxheShjYWxsYmFjaywgeyBkZWxheTogdGhpcy5zdGFnZS5NT1ZFX0RVUkFUSU9OICogMC40ICogMTAwMCwgcGFyZW50OiBhY3Rpb24gfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHBhcnNlTmV4dEFjdGlvbihzY3JpcHQsIGNhbGxiYWNrKSB7XG4gICAgICAgIC8vIENoZWNrIGlmIHNjcmlwdCBpcyBjb21wbGV0ZVxuICAgICAgICBpZiAoc2NyaXB0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgLy8gQ3V0c2NlbmUgZmluaXNoZWQgc3VjY2Vzc3VsbHlcbiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGNhbGxiYWNrKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYXJzZSBjdXJyZW50IGxpbmUgb2Ygc2NyaXB0XG4gICAgICAgIGxldCBhY3Rpb24gPSBzY3JpcHRbMF1cblxuICAgICAgICAvLyBDb25maXJtIGNvbW1hbmQgZXhpc3RzXG4gICAgICAgIGlmICghYWN0aW9uIHx8ICF0aGlzLmFjdGlvbnMuaGFzT3duUHJvcGVydHkoYWN0aW9uLmNvbW1hbmQpKSB7XG4gICAgICAgICAgICAvLyBJbnZhbGlkIGNvbW1hbmQsIGVuZCBjdXRzY2VuZVxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2FsbGJhY2spXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJ1biBhY3Rpb25cbiAgICAgICAgaWYgKGFjdGlvbi53YWl0KSB7XG4gICAgICAgICAgICAvLyBDb21wbGV0ZSB0aGlzIGFjdGlvbiBiZWZvcmUgcHJvY2VlZGluZ1xuICAgICAgICAgICAgbGV0IG5ld0NhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXJzZU5leHRBY3Rpb24oc2NyaXB0LnNsaWNlKDEpLCBjYWxsYmFjaylcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKVxuICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbi5jb21tYW5kXS5jYWxsKHRoaXMsIG5ld0NhbGxiYWNrLCBhY3Rpb24pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBQZXJmb3JtIHRoaXMgYWN0aW9uIGFuZCBpbW1lZGlhdGVseSBjb250aW51ZVxuICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbi5jb21tYW5kXS5jYWxsKHRoaXMsIHRoaXMuZW1wdHksIGFjdGlvbilcbiAgICAgICAgICAgIHRoaXMucGFyc2VOZXh0QWN0aW9uKHNjcmlwdC5zbGljZSgxKSwgY2FsbGJhY2spXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBVc2VkIGZvciBjYWxsYmFja3MgdGhhdCBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nLiBcbiAgICAvLyBVc2VkIHNvIGFjdGlvbnMgZG9uJ3QgbmVlZCB0byBkZWFsIHdpdGggdW5kZWZpbmVkIG9yIG51bGwgY2FsbGJhY2tzLCBcbiAgICAvLyAgYW5kIHRvIG5vdCBtZXNzIHVwIHRoZSBwYXJhbWV0ZXIgb3JkZXJcbiAgICBlbXB0eSgpIHt9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ3V0c2NlbmVcbiJdfQ==